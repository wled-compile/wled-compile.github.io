<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="copyright" content="&copy; 2023 Wladislaw Waag" />
  <title>WLED Online compiler</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <link rel="stylesheet" href="index.css">
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
<div class="container">
<h3 style="font-weight: bold;"><span style="color:red">W</span><span style="color:orange">L</span><span style="color:darkblue">E</span><span style="color:lightpink">D</span><span style="color:mediumblue"> o</span><span style="color:brown">n</span><span style="color:hotpink">l</span><span style="color:lightcoral">i</span><span style="color:red">n</span><span style="color:seagreen">e</span><span style="color:crimson"> c</span><span style="color:darkgreen">o</span><span style="color:darkmagemnta">m</span><span style="color:darkblue">p</span><span style="color:red">i</span><span style="color:darksalmon">l</span><span style="color:lightpink">e</span><span style="color:red">r</span></h3>
	<div class="form-floating mb-1">
	  <select id="lang" onchange="LangChanged();" class="form-select" aria-label="" style="min-width: 200px; width:auto;">
			<option value="0">Deutsch</option>
			<option value="1">English</option>
	  </select>
	  <label for="lang">Language/Sprache:</label>
	</div>
	<div class="form-floating mb-1">
		<h4 id="L07">Kompiliere Dir eigene WLED Software online mit nur wenigen Klicks!</h4>
		<p><span id="L25">(alter compile helper hier: </span><a href="./index1.html">old compile helper</a>)</p>
	</div>
	<div class="form-floating mb-1">
		<p><span id="L35" style="color:red">Achtung: bitte geben Sie bei der Konfiguration der WLED SW keine personenbezogenen Daten (Name etc.) und keine geheimen Informationen (Passwörter etc.) ein! Das kompilieren erfolgt auf öffentlich zugänglichen Servern, so dass jeder die von Ihnen eingegebenen Informationen einsehen kann!</p>
	</div>
	<div class="accordion accordion-flush" id="MainAccordion">
	<div class="accordion-item">
	<h2 class="accordion-header" id="headingMainDetails1">
	  <button class="accordion-button collapsed" style="padding-left:0;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne1" aria-expanded="true" aria-controls="collapseOne1">
		<span id="L30" style="color:blue;text-decoration: underline;">Schritt 1: WLED Software / Release / Controller-Typ auswählen</span>
	  </button>
	</h2>
	<div id="collapseOne1" class="accordion-collapse collapse" aria-labelledby="headingMainDetails1" data-bs-parent="#MainAccordion">
	<div class="accordion-body">
	<div class="row row-cols-auto">
		<div class="col mb-1">
		  <div class="form-floating">
			<select id="select-sources" onchange="SourceChanged();" class="form-select" aria-label="" style="min-width: 20em; width:auto;"></select>
			<label for="select-sources"><span id="L01">Quelle der WLED SW auswählen (Abzweigung):</span></label>
		  </div>
		</div>
		<div class="col mb-1">
		  <div class="form-floating">
			<select id="select-branches" onchange="BranchChanged();" class="form-select" aria-label="" style="min-width: 20em; width:auto;"></select>
			<label for="select-branches"><span id="L02">Branch / Release auswählen</span></label>
		  </div>
		</div>
		<div class="col mb-1">
		  <div class="form-floating">
			<select id="select-enviroments" onchange="EnvChanged();" class="form-select" aria-label="" style="min-width: 20em; width:auto;" ></select>
			<label for="select-enviroments"><span id="L03">Mikrocontroller Typ auswählen:</span></label>
		  </div>
		</div>
	</div>
	<div class="row row-cols-auto" id="UserInputRow">
		<div class="col mb-1">
		  <div class="form-floating">
			<input id="input-username" onchange="UserRepoChanged();" class="form-control" aria-label="" style="min-width: 20em; width:auto;"></select>
			<label for="input-username"><span id="L26">Your GitHub user name:</span></label>
		  </div>
		</div>
		<div class="col mb-1">
		  <div class="form-floating">
			<input id="input-reponame" onchange="UserRepoChanged();" class="form-control" aria-label="" style="min-width: 20em; width:auto;"></select>
			<label for="input-reponame"><span id="L27">Your GitHub repository:</span></label>
		  </div>
		</div>
	</div>
	</div>
	</div>
	</div>
	<div class="accordion-item">
	<h2 class="accordion-header" id="headingMainDetails2">
	  <button class="accordion-button collapsed" style="padding-left:0;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne2" aria-expanded="true" aria-controls="collapseOne2">
		<span id="L31" style="color:blue;text-decoration: underline;"> Schritt 2: Optionen auswählen</span>
	  </button>
	</h2>
	<div id="collapseOne2" class="accordion-collapse collapse" aria-labelledby="headingMainDetails2" data-bs-parent="#MainAccordion">
	<div class="accordion-body">
	<div id="div-options">
		
	</div>
	</div>
	</div>
	</div>
	
	<div class="accordion-item">
	<h2 class="accordion-header" id="headingMainDetails3">
	  <button class="accordion-button collapsed" style="padding-left:0;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne3" aria-expanded="true" aria-controls="collapseOne3">
		<span id="L32" style="color:blue;text-decoration: underline;"> Schritt 3: UserMods auswählen</span>
	  </button>
	</h2>
	<div id="collapseOne3" class="accordion-collapse collapse" aria-labelledby="headingMainDetails3" data-bs-parent="#MainAccordion">
	<div class="accordion-body">
	<div id="div-usermods">
		
	</div>
	</div>
	</div>
	</div>
	
	<div class="accordion-item">
	<h2 class="accordion-header" id="headingMainDetails4">
	  <button class="accordion-button collapsed" style="padding-left:0;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne4" aria-expanded="true" aria-controls="collapseOne4">
		<span id="L06" style="color:blue;text-decoration: underline;"> Schritt 4: prüfe generierte Konfiguration (ignoriere, wenn Du nicht weiss was das ist)</span>
	  </button>
	</h2>
	<div id="collapseOne4" class="accordion-collapse collapse" aria-labelledby="headingMainDetails4" data-bs-parent="#MainAccordion">
	<div class="accordion-body">
	<div class="input-group">
	  <span class="input-group-text"></span>
	  <textarea class="form-control" rows="5" id="env-text"></textarea>
	</div>
	</div>
	</div>
	</div>
	<div class="accordion-item">
	<h2 class="accordion-header" id="headingMainDetails5">
	  <button class="accordion-button collapsed" style="padding-left:0;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne5" aria-expanded="true" aria-controls="collapseOne5">
		<span id="L33" style="color:blue;text-decoration: underline;"> Schritt 5: Kompilieren starten und nach Abschluss SW herunterladen</span>
	  </button>
	</h2>
	<div id="collapseOne5" class="accordion-collapse collapse" aria-labelledby="headingMainDetails4" data-bs-parent="#MainAccordion">
	<div class="accordion-body">
	<div class="container m-0 p-2">
	<button type="button" class="btn btn-primary" onclick="StartBuildOnline()"><span span id="L22">Kompilieren starten</span></button>
	<a id="downloadLinkYAML" href="" download="wled_compile.yaml" style="display: none;"></a>
	
	<div class="container m-0 p-2">
	<div class="row row-cols-auto">
	  <div class="col mb-1">
		<h5><span id="L34">Ergebnisse</span></h5>
	  </div>
	  <div class="col mb-1">
		<div class="spinner-border text-primary" role="status" id="spinner"></div>
	  </div>
	</div>
	<p id="result_line1"></p>
	<p id="result_line2"></p>
	<p id="result_line3"></p>
	<div><small id="L36">Diese Software ist open source und wird kostenfrei zur Verfügung gestellt. Es werden keine bestimmten Eigenschaften der Software zugesichert. Der Inhaber dieser Webseite haftet nur für Vorsatz und grobe Fahrlässigkeit. Gewährleistungspflichten treffen ihn nur, wenn er Mängel der Software arglistig verschwiegen hat.</small></div>
    <div><small id="L37">Bitte beachten Sie die Software Lizenzen: <a href="https://wled-install.github.io/WLED_Software_Lizenzen.pdf">WLED licenses</a></small></div>
	</div>
	
    </div>
	</div>
	</div>
	</div>
	</div>
<hr>
		<div class="container inst-button">
          <esp-web-install-button id="install_btn" manifest="https://raw.githubusercontent.com/wled-compile1/myrepo1/refs/heads/main/20241117/ZyPqDx1bn7a97bDi1iek/manifest_file.json" >
            <button class="btn btn-primary" slot="activate"><span id="L09">Installieren</span></button>
          </esp-web-install-button>
		</div>
<hr>
        <div class="container">
        <h5 id="L14">Nützliche Informationen:</h5>
		<ul>
          <li><span id="L14a">Offizielle WLED Wiki (Englisch):</span> <a href="https://kno.wled.ge">https://kno.wled.ge</a></li>
		  <li><span id="L14f">WLED FAQ: <a href="https://wled-faq.github.io">https://wled-faq.github.io</a></span></li>
          <li><span id="L14b">DIY WLED boards:</span> <a href="https://github.com/wladwnt/wled">Github</a></li>
          <li><span id="L14c">Professionelle WLED Boards:<a href="https://shop.myhome-control.de">MyHome-Control Shop</a></span></li>
          <li><span id="L14d">WEB-based WLED software installer:</span> <a href="https://wled-install.github.io">WLED-INSTALL</a></li>
		  <li><span id="L14e">WLED power calculator: </span><a href="https://wled-calculator.github.io">https://wled-calculator.github.io</a></li>
        </ul>
      </div>
	  
<div class="container">
   <div class="accordion accordion-flush bottompart" id="accordionBottom">
		<div class="accordion-item">
			<h4 class="accordion-header" id="headingImprint">
			  <button class="accordion-button collapsed bottompart" style="padding-left:0;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseImprint" aria-expanded="true" aria-controls="collapseOne">
				<span id="L18" style="color:blue;text-decoration: underline;">Impressum</span>
			  </button>
			</h4>
			<div id="collapseImprint" class="accordion-collapse collapse bottompart" aria-labelledby="headingImprint" data-bs-parent="#accordionBottom">
			  <div class="accordion-body bottompart">
				<small><span id="L19"><br><h3>Impressum</h3>Verantwortlicher: Wladislaw Waag<br>Adresse: Wasserburger Landstr. 29, 81825 München, Deutschland<br>Kontakt: +49 (0) 176 47 11 5206, info@myhome-control.de<br><br>EU-Streitschlichtung: Die Europäische Kommission stellt eine Plattform zur Online-Streitbeilegung (OS) bereit: <a href='https://ec.europa.eu/consumers/odr/' target='_blank'>https://ec.europa.eu/consumers/odr/</a>.<br><br>Verbraucherstreitbeilegung/Universalschlichtungsstelle: Wir sind nicht bereit oder verpflichtet, an Streitbeilegungsverfahren vor einer Verbraucherschlichtungsstelle teilzunehmen.</span></small>
			  </div>
			</div>
		</div>
		
		<div class="accordion-item bottompart">
			<h4 class="accordion-header bottompart" id="headingPrivacy">
			  <button class="accordion-button collapsed bottompart" style="padding-left:0;" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePrivacy" aria-expanded="true" aria-controls="collapseOne">
				<span id="L20" style="color:blue;text-decoration: underline;">Datenschutzerklärung</span>
			  </button>
			</h4>
			<div id="collapsePrivacy" class="accordion-collapse collapse bottompart" aria-labelledby="headingPrivacy" data-bs-parent="#accordionBottom">
			  <div class="accordion-body bottompart">
				<small><span id="L21"><br><h3>Datenschutzerklärung</h3> Diese Seite wird im Rahmen von 'Github Pages' gehostet und betrieben. Es ist möglich und wahrscheinlich, dass Github Ihre personenbezogenen Daten sammelt und verarbeitet. Das betrifft dann auch die Besucher der Webseite wled-compile.github.io. Wir haben aber keinerlei Einfluss darauf. Bitte lesen Sie dazu die Datenschutzerklärung von Github: <a href='https://docs.github.com/en/github/site-policy/github-privacy-statement' target='_blank'>https://docs.github.com/en/github/site-policy/github-privacy-statement</a><br><br>Außerdem sobald Sie mit Kompilieren starten, werden Ihre IP Adresse sowie alle von Ihnen eingegebenen Daten an https://myhome-control.de weitergeleitet. Das ist für die Ausführung des Auftrags zwingend notwendig. Die Datenschutzerklärung dazu finden Sie unter <a href=‘https://shop.myhome-control.de/Information/Datenschutz/‘>https://shop.myhome-control.de/Information/Datenschutz/</a><br><br>Unsere Webseite enthält Links zu externen Webseiten Dritter, auf deren Inhalte wir keinen Einfluss haben. Für diese fremden Inhalte können wir keine Gewähr und keine Haftung übernehmen. Für die Inhalte der verlinkten Seiten ist immer der jeweilige Anbieter oder Betreiber der Seiten verantwortlich. Die verlinkten Seiten wurden zum Zeitpunkt der Verlinkung auf mögliche Rechtsverstöße überprüft. Rechtswidrige Inhalte waren dabei nicht erkennbar. Sollten uns Rechtsverletzungen bekannt werden, werden wir die entsprechende Verlinkung umgehend entfernen.</span></small>
			  </div>
			</div>
		</div>
	  </div>
</div>
</div>
<script>
var dataset;

function UserRepoChanged() {
	var SS = document.getElementById('select-sources');
	var SI=SS.selectedIndex;
	if(SS.options[SI].getAttribute("custom")==="1") {
		SS.options[SI].setAttribute("ghusername",document.getElementById('input-username').value);
		SS.options[SI].setAttribute("ghreponame",document.getElementById('input-reponame').value);
	}
	SearchForBranchesAndReleases();
}

function SearchForBranchesAndReleases(){
	sel=document.getElementById('select-branches');
	while (sel.options.length > 0) {
        sel.remove(0);
    }
	var opt = document.createElement('option');
    opt.value = 0;
    opt.innerHTML = 'Searching for branches ...';
    sel.appendChild(opt);
	
	sel=document.getElementById('select-enviroments');
	while (sel.options.length > 0) {
        sel.remove(0);
    }
	var opt = document.createElement('option');
    opt.value = 0;
    opt.innerHTML = 'Searching for enviroments in platformio.ini ...';
    sel.appendChild(opt);
	
	var SS = document.getElementById('select-sources');
	var SI=SS.selectedIndex;
	var mReq = new XMLHttpRequest();
	mReq.open('GET', 'https://api.github.com/repos/'+SS.options[SI].getAttribute("ghusername")+'/'+SS.options[SI].getAttribute("ghreponame")+'/branches');
	mReq.responseType = 'json';
	mReq.onreadystatechange = function () {
	  if (this.readyState == 4) {
		if(mReq.status === 200) {
			var SS = document.getElementById('select-sources');
			var SI=SS.selectedIndex;
			sel=document.getElementById('select-branches');
			while (sel.options.length > 0) {
				sel.remove(0);
			}
			var json=this.response;
			for(let i = 0; i < json.length; i++) {
				let obj = json[i];
				var opt = document.createElement('option');
				opt.value = i;
				opt.setAttribute("type","branch");
				opt.setAttribute("bname",obj.name);
				opt.setAttribute("url",'https://github.com/' + SS.options[SI].getAttribute("ghusername") + '/' + SS.options[SI].getAttribute("ghreponame") + '/archive/refs/heads/'+obj.name+'.zip');
				opt.setAttribute("pio_url",'https://raw.githubusercontent.com/' + SS.options[SI].getAttribute("ghusername") + '/' + SS.options[SI].getAttribute("ghreponame") + '/'+obj.name+'/platformio.ini');
				opt.innerHTML = 'Branch: \"'+obj.name+'"';
				if(SS.options[SI].getAttribute("recommendedbranch")===obj.name) {
				opt.innerHTML = opt.innerHTML + ' (RECOMMENDED)';
				
				}
				sel.appendChild(opt);
			}
			// set RECOMMENDED
			for(i = 0; i < sel.options.length; i++) {
			   if (sel.options[i].innerHTML.includes("(RECOMMENDED)")) {
				   sel.value=sel.options[i].value;
			   }
			 }
			
			///////////////////////////////////
			if(SS.options[SI].getAttribute("custom")==="0") {
				var mReq1 = new XMLHttpRequest();
				mReq1.open('GET', 'https://api.github.com/repos/'+SS.options[SI].getAttribute("ghusername")+'/'+SS.options[SI].getAttribute("ghreponame")+'/releases');
				mReq1.responseType = 'json';
				mReq1.onreadystatechange = function () {
				  if (this.readyState == 4) {
					if(mReq1.status === 200) {
						var SS = document.getElementById('select-sources');
						var SI=SS.selectedIndex;
						sel=document.getElementById('select-branches');
						NN=sel.length;
						var json=this.response;
						for(let i = 0; i < json.length; i++) {
							let obj = json[i];
							var opt = document.createElement('option');
							opt.value = i+NN-1;
							opt.setAttribute("type","release");
							opt.setAttribute("bname",obj.tag_name);
							opt.setAttribute("url",obj.zipball_url);
							opt.setAttribute("pio_url",'https://raw.githubusercontent.com/' + SS.options[SI].getAttribute("ghusername") + '/' + SS.options[SI].getAttribute("ghreponame") + '/'+obj.tag_name+'/platformio.ini');
							opt.innerHTML = 'Release: \"'+obj.tag_name+'"';
							sel.appendChild(opt);
						}
						BranchChanged();
					}
				  }
				}	
				mReq1.send();
			} else {
				BranchChanged();
			}
			///////////////////////////////////
			
		}
	  }
	}	
	mReq.send();
}

function SourceChanged() {
	var SS = document.getElementById('select-sources');
	var SI=SS.selectedIndex;
	if(SS.options[SI].getAttribute("custom")==="0") {
		document.getElementById('input-username').value = SS.options[SI].getAttribute("ghusername");
		document.getElementById('input-reponame').value = SS.options[SI].getAttribute("ghreponame");
		document.getElementById('input-username').disabled = true;
		document.getElementById('input-reponame').disabled = true;
	} else {
		document.getElementById('input-username').value = "";
		document.getElementById('input-reponame').value = "";
		document.getElementById('input-username').disabled = false;
		document.getElementById('input-reponame').disabled = false;
	}
	
	SearchForBranchesAndReleases();
}

function BranchChanged() {
	var SB = document.getElementById('select-branches');
	var SI=SB.selectedIndex;
	
	sel=document.getElementById('select-enviroments');
	while (sel.options.length > 0) {
        sel.remove(0);
    }
	var opt = document.createElement('option');
    opt.value = 0;
    opt.innerHTML = 'Searching for enviroments in platformio.ini ...';
    sel.appendChild(opt);

	var mReq = new XMLHttpRequest();
	mReq.open('GET', SB.options[SI].getAttribute("pio_url"));
	mReq.responseType = 'plain/text';
	mReq.onreadystatechange = function () {
	  if (this.readyState == 4) {
		if(mReq.status === 200) {
			//console.log(this.response)
			sel=document.getElementById('select-enviroments');
			while (sel.options.length > 0) {
				sel.remove(0);
			}
			splitted=this.response.replaceAll("\r\n","\n").replaceAll("\r","\n").split("\n");
			var SS = document.getElementById('select-sources');
			var SSI=SS.selectedIndex;
			for (var i = 0; i < splitted.length; i++) {
				if(splitted[i].replaceAll(" ","").replaceAll("\t","").startsWith("[env:")) {
					envname1=splitted[i].replaceAll(" ","").replaceAll("\t","").replaceAll("[env:","");
					envname=envname1.substr(0, envname1.indexOf(']'));
					if(!(envname.toLowerCase().includes("codm") || envname.toLowerCase().includes("athom") || envname.toLowerCase().includes("travis") || envname.toLowerCase().includes("sp5") || envname.toLowerCase().includes("h803") || envname.toLowerCase().includes("heltec")  || envname.toLowerCase().includes("elekstube") || envname.toLowerCase().includes("anavi") || envname.toLowerCase().includes("my92"))) {
						//console.log(envname);
						var opt = document.createElement('option');
						opt.value = 0;
						opt.innerHTML = envname;
						if(envname===SS.options[SSI].getAttribute("recommended_esp8266")) opt.innerHTML = opt.innerHTML + " (RECOMMENDED for ESP8266)";
						if(envname===SS.options[SSI].getAttribute("recommended_esp32")) opt.innerHTML = opt.innerHTML + " (RECOMMENDED for ESP32)";
						opt.setAttribute("env",envname);
						sel.appendChild(opt);
					}
				}
			}
			EnvChanged();
		}
	  }
	}
	mReq.send();
}

function GetSettingsHtml(setting, DoNotCheckSource, stri) {
	retval="";
	var SS=parseInt(document.getElementById('select-sources').selectedIndex);
	if(setting.type=="checkbox" && (DoNotCheckSource || setting.sources.includes(SS))) {
		retval='<div class="row row-cols-auto"><div class="col mb-1"><div class="form-check"><input class="form-check-input" type="checkbox" id="checkbox-set'+stri+'" name="option-set'+stri+'" value="something" onchange="GenerateEnvText();">  <label class="form-check-label">'+setting.name+'</label></div></div></div>';
	}
	if((setting.type=="number" || setting.type=="number_float") && (DoNotCheckSource || setting.sources.includes(SS))) {
		retval='<div class="row row-cols-auto"><div class="col mb-1"><div class="form-check"><input class="form-check-input" type="checkbox" id="checkbox-set'+stri+'" name="option-set'+stri+'" value="something" onchange="GenerateEnvText();">  <label class="form-check-label">'+setting.name+'</label></div></div><div class="col mb-1"><input id="input-number-'+stri+'" type="number" min="-1" data-bind="value:input-number-'+stri+'" onchange="GenerateEnvText();" class="form-control" aria-label="" style="width: 10em;"></div></div>';
	}
	if((setting.type=="string" || setting.type=="defparam") && (DoNotCheckSource || setting.sources.includes(SS))) {
		retval='<div class="row row-cols-auto"><div class="col mb-1"><div class="form-check"><input class="form-check-input" type="checkbox" id="checkbox-set'+stri+'" name="option-set'+stri+'" value="something" onchange="GenerateEnvText();">  <label class="form-check-label">'+setting.name+'</label></div></div><div class="col mb-1"><input id="input-string-'+stri+'" data-bind="value:input-string-'+stri+'" onchange="GenerateEnvText();" class="form-control" aria-label="" style="width: 30em;"></div></div>';
	}
	return retval;
}

function ChangeVisibilityUsermodOptions(i) {
	options_div=document.getElementById('UMOptionsList'+String(i));
	if(options_div) {
		if(document.getElementById('checkbox-setum'+String(i)).checked) {
			options_div.style.display = "inherit";
		} else {
			options_div.style.display = "none";
		}
	}
}

function EnvChanged() {
	var SI=parseInt(document.getElementById('select-sources').selectedIndex);
	
	options_div=document.getElementById('div-options');
	  options_div.innerHTML="";
	  var SS=parseInt(document.getElementById('select-sources').selectedIndex);
	  for(var i = 0; i < dataset.settings.length; i++) {
		options_div.innerHTML=options_div.innerHTML+GetSettingsHtml(dataset.settings[i], false, String(i));
      }
	
	options_div=document.getElementById('div-usermods');
	  options_div.innerHTML="";
	  var SS=parseInt(document.getElementById('select-sources').selectedIndex);
	  for(var i = 0; i < dataset.usermods.length; i++) {
		if(dataset.usermods[i].type=="checkbox" && dataset.usermods[i].sources.includes(SS)) {
			prefix = '<div class="row row-cols-auto"><div class="col mb-1"><div class="form-check"><input class="form-check-input" type="checkbox" id="checkbox-setum'+String(i)+'" name="option-setum'+String(i)+'" value="something" onchange="ChangeVisibilityUsermodOptions('+String(i)+');GenerateEnvText();">  <label class="form-check-label-um">'+dataset.usermods[i].name+'   <a href="'+dataset.usermods[i].readme+'" target="_blank">README</a></label><div id="UMOptionsList'+String(i)+'" style="display:none">';
			
			middlepart='';
			if("options" in dataset.usermods[i]) {
				for(var j = 0; j < dataset.usermods[i].options.length; j++) {
					middlepart=middlepart+GetSettingsHtml(dataset.usermods[i].options[j], true, 'UMopt'+String(i)+'_'+String(j))
				}
			}
			postfix = '</div></div></div></div>';
			options_div.innerHTML=options_div.innerHTML+prefix+middlepart+postfix;
		}
      }
	GenerateEnvText();
}

function LoadDataset() {
  const xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      dataset = JSON.parse(this.responseText);
	  sel=document.getElementById('select-sources');
      for(var i = 0; i < dataset.sources.length; i++) {
	    if(dataset.sources[i].custom==0) {
			var opt = document.createElement('option');
			opt.value = i;
			opt.innerHTML = dataset.sources[i].name;
			opt.setAttribute("ghusername",dataset.sources[i].githubusername);
			opt.setAttribute("ghreponame",dataset.sources[i].githubreponame);
			opt.setAttribute("custom",dataset.sources[i].custom);
			opt.setAttribute("recommendedbranch",dataset.sources[i].recommendedbranch);
			opt.setAttribute("recommended_esp8266",dataset.sources[i].recommended_esp8266);
			opt.setAttribute("recommended_esp32",dataset.sources[i].recommended_esp32);
			sel.appendChild(opt);
		}
      }
	  SourceChanged();	  
    }
  };
  xhttp.open("GET", "dataset.json");
  xhttp.send(); 
}

function GetFlagsAndDepsForSetting(setting, stri) {
	var buildflags="";
	var libdeps="";
	
	if(document.getElementById('checkbox-set'+stri).checked) {
		if(String(setting.build_flags).length>0) {
		buildflags=buildflags+" "+setting.build_flags;
			if(setting.type=="number" || setting.type=="number_float") {
				numval=String(document.getElementById('input-number-'+stri).value);
				if(numval.length==0) {
					numval="0";
				}
				if(setting.type=="number_float") numval=numval+"f";
				buildflags=buildflags+numval;
			}
			if(setting.type=="string") {
				stringval=String(document.getElementById('input-string-'+stri).value);
				buildflags=buildflags+"'\""+stringval+"\"'";
			}
			if(setting.type=="defparam") {
				stringval=String(document.getElementById('input-string-'+stri).value);
				buildflags=buildflags+stringval;
			}
		}
		if(String(setting.lib_deps).length>0) {
			libdeps=libdeps+"\n  "+setting.lib_deps;
		}
	}
	
	return [buildflags, libdeps];
}

function GenerateEnvText() {
envtextfield=document.getElementById('env-text');
SS=document.getElementById('select-sources')
SSI=SS.selectedIndex;
SE=document.getElementById('select-enviroments');
SEI=SE.selectedIndex;

var value="[env:custom_build]\nextends = env:"+SE.options[SEI].getAttribute("env");

var buildflags="";
var libdeps="";

	for(var i = 0; i < dataset.settings.length; i++) {
		if((dataset.settings[i].type=="checkbox" || dataset.settings[i].type=="number" || dataset.settings[i].type=="number_float" || dataset.settings[i].type=="string"  || dataset.settings[i].type=="defparam") && dataset.settings[i].sources.includes(SSI)) {
			[buildflags_add, libdeps_add] = GetFlagsAndDepsForSetting(dataset.settings[i], String(i));
			buildflags=buildflags+buildflags_add;
			libdeps=libdeps+libdeps_add;
		}

	}
	for(var i = 0; i < dataset.usermods.length; i++) {
		if(dataset.usermods[i].type=="checkbox" && dataset.usermods[i].sources.includes(SSI)) {
			if(document.getElementById('checkbox-setum'+String(i)).checked) {
				if(String(dataset.usermods[i].build_flags).length>0) {
					buildflags=buildflags+" "+dataset.usermods[i].build_flags;
				}
				if(String(dataset.usermods[i].lib_deps).length>0) {
					libdeps=libdeps+"\n  "+dataset.usermods[i].lib_deps;
				}
				if("options" in dataset.usermods[i]) {
					for(var j = 0; j < dataset.usermods[i].options.length; j++) {
						[buildflags_add, libdeps_add] = GetFlagsAndDepsForSetting(dataset.usermods[i].options[j], 'UMopt'+String(i)+'_'+String(j));
						buildflags=buildflags+buildflags_add;
						libdeps=libdeps+libdeps_add;
					}
				}
			}
		}
	}
	
	if(String(buildflags).length>0) {
		value=value+"\nbuild_flags = ${env:"+SE.options[SEI].getAttribute("env")+".build_flags}"+buildflags;
	}
	if(String(libdeps).length>0) {
		value=value+"\nlib_deps = \n  ${env:"+SE.options[SEI].getAttribute("env")+".lib_deps}"+libdeps;
	}
	
envtextfield.value=value;
}

function LangChanged() {
    if(document.getElementById('lang').selectedIndex==0) {
		if(document.getElementById('L01')) document.getElementById('L01').innerHTML = "Quelle der WLED SW auswählen (Abzweigung):";
		if(document.getElementById('L02')) document.getElementById('L02').innerHTML = "Branch / Release auswählen:";
		if(document.getElementById('L03')) document.getElementById('L03').innerHTML = "Mikrocontroller Typ auswählen:";
		if(document.getElementById('L04')) document.getElementById('L04').innerHTML = "Optionen:";
		if(document.getElementById('L05')) document.getElementById('L05').innerHTML = "UserMods verwenden (ggf. max Anzahl von usermods oben in Optionen anpassen!):";
		if(document.getElementById('L06')) document.getElementById('L06').innerHTML = "Schritt 4: prüfe generierte Konfiguration (ignoriere, wenn Du nicht weiss was das ist):";
		if(document.getElementById('L07')) document.getElementById('L07').innerHTML = 'Kompiliere Dir eigene WLED Software online mit nur wenigen Klicks!'
		if(document.getElementById('L18')) document.getElementById('L18').innerHTML = 'Impressum';
        if(document.getElementById('L20')) document.getElementById('L20').innerHTML = 'Datenschutzerklärung';
		if(document.getElementById('L19')) document.getElementById('L19').innerHTML =  "<br><h3>Impressum</h3>Verantwortlicher: Wladislaw Waag<br>Adresse: Wasserburger Landstr. 29, 81825 München, Deutschland<br>Kontakt: +49 (0) 176 47 11 5206, info@myhome-control.de<br><br>EU-Streitschlichtung: Die Europäische Kommission stellt eine Plattform zur Online-Streitbeilegung (OS) bereit: <a href='https://ec.europa.eu/consumers/odr/' target='_blank'>https://ec.europa.eu/consumers/odr/</a>.<br><br>Verbraucherstreitbeilegung/Universalschlichtungsstelle: Wir sind nicht bereit oder verpflichtet, an Streitbeilegungsverfahren vor einer Verbraucherschlichtungsstelle teilzunehmen.";
		if(document.getElementById('L21')) document.getElementById('L21').innerHTML = "<br><h3>Datenschutzerklärung</h3> Diese Seite wird im Rahmen von 'Github Pages' gehostet und betrieben. Es ist möglich und wahrscheinlich, dass Github Ihre personenbezogenen Daten sammelt und verarbeitet. Das betrifft dann auch die Besucher der Webseite wled-compile.github.io. Wir haben aber keinerlei Einfluss darauf. Bitte lesen Sie dazu die Datenschutzerklärung von Github: <a href='https://docs.github.com/en/github/site-policy/github-privacy-statement' target='_blank'>https://docs.github.com/en/github/site-policy/github-privacy-statement</a><br><br>Außerdem sobald Sie mit Kompilieren starten, werden Ihre IP Adresse sowie alle von Ihnen eingegebenen Daten an https://myhome-control.de weitergeleitet. Das ist für die Ausführung des Auftrags zwingend notwendig. Die Datenschutzerklärung dazu finden Sie unter <a href=‘https://shop.myhome-control.de/Information/Datenschutz/‘>https://shop.myhome-control.de/Information/Datenschutz/</a><br><br>Unsere Webseite enthält Links zu externen Webseiten Dritter, auf deren Inhalte wir keinen Einfluss haben. Für diese fremden Inhalte können wir keine Gewähr und keine Haftung übernehmen. Für die Inhalte der verlinkten Seiten ist immer der jeweilige Anbieter oder Betreiber der Seiten verantwortlich. Die verlinkten Seiten wurden zum Zeitpunkt der Verlinkung auf mögliche Rechtsverstöße überprüft. Rechtswidrige Inhalte waren dabei nicht erkennbar. Sollten uns Rechtsverletzungen bekannt werden, werden wir die entsprechende Verlinkung umgehend entfernen.";
		if(document.getElementById('L14a')) document.getElementById('L14a').innerHTML = 'Offizielle WLED Wiki (Englisch): ';
		if(document.getElementById('L14f')) document.getElementById('L14f').innerHTML = 'WLED FAQ: <a href="https://wled-faq.github.io">https://wled-faq.github.io</a>';
		if(document.getElementById('L14b')) document.getElementById('L14b').innerHTML = 'DIY WLED Boards:';
        if(document.getElementById('L14c')) document.getElementById('L14c').innerHTML = 'Professionelle WLED Controller: <a href="https://shop.myhome-control.de">MyHome-Control Shop</a>';
        if(document.getElementById('L14d')) document.getElementById('L14d').innerHTML = 'WEB-basierter WLED Software Installer: ';
		if(document.getElementById('L14e')) document.getElementById('L14e').innerHTML = 'WLED power calculator: ';
		if(document.getElementById('L14')) document.getElementById('L14').innerHTML = "Nützliche Informationen:";
		if(document.getElementById('L22')) document.getElementById('L22').innerHTML = "Kompilieren starten";
		if(document.getElementById('L25')) document.getElementById('L25').innerHTML = '(alter compile helper hier: ';
		if(document.getElementById('L26')) document.getElementById('L26').innerHTML = 'Deine GitHub Account Name';
		if(document.getElementById('L27')) document.getElementById('L27').innerHTML = 'Deine GitHub Repository';
		if(document.getElementById('L30')) document.getElementById('L30').innerHTML = 'Schritt 1: WLED Software / Release / Controller-Typ auswählen';
		if(document.getElementById('L31')) document.getElementById('L31').innerHTML = 'Schritt 2: Optionen wählen';
		if(document.getElementById('L32')) document.getElementById('L32').innerHTML = 'Schritt 3: UserMods auswählen';
		if(document.getElementById('L33')) document.getElementById('L33').innerHTML = 'Schritt 5: Kompilieren starten und nach Abschluss SW herunterladen';
		if(document.getElementById('L34')) document.getElementById('L34').innerHTML = 'Ergebnisse zum Herunterladen:';
		if(document.getElementById('L35')) document.getElementById('L35').innerHTML = 'Achtung: Bitte geben Sie bei der Konfiguration der WLED SW keine personenbezogenen Daten (Name etc.) und keine geheimen Informationen (Passwörter etc.) ein! Das kompilieren erfolgt auf öffentlich zugänglichen Servern, so dass jeder die von Ihnen eingegebenen Informationen einsehen kann!';
		if(document.getElementById('L36')) document.getElementById('L36').innerHTML = 'Diese Software ist open source und wird kostenfrei zur Verfügung gestellt. Es werden keine bestimmten Eigenschaften der Software zugesichert. Der Inhaber dieser Webseite haftet nur für Vorsatz und grobe Fahrlässigkeit. Gewährleistungspflichten treffen ihn nur, wenn er Mängel der Software arglistig verschwiegen hat.';
		if(document.getElementById('L37')) document.getElementById('L37').innerHTML = 'Bitte beachten Sie die Software Lizenzen: <a href="https://wled-install.github.io/WLED_Software_Lizenzen.pdf">WLED licenses</a>';
		
	} else {
		if(document.getElementById('L01')) document.getElementById('L01').innerHTML = "Select WLED source (fork):";
		if(document.getElementById('L02')) document.getElementById('L02').innerHTML = "Select branch/release:";
		if(document.getElementById('L03')) document.getElementById('L03').innerHTML = "Select microcontroller type:";
		if(document.getElementById('L04')) document.getElementById('L04').innerHTML = "Options:";
		if(document.getElementById('L05')) document.getElementById('L05').innerHTML = "Include usermods (please eventually change max. number of usermods under Options above):";
		if(document.getElementById('L06')) document.getElementById('L06').innerHTML = "Step 4: check generated configuration (ignore if you don't know what this is):";
		if(document.getElementById('L07')) document.getElementById('L07').innerHTML = 'Compile your own WLED software online with just a few clicks!';
	    if(document.getElementById('L18')) document.getElementById('L18').innerHTML = 'Legal notice';
        if(document.getElementById('L20')) document.getElementById('L20').innerHTML = 'Data privacy';
		if(document.getElementById('L19')) document.getElementById('L19').innerHTML =  "<br><h3>Legal notice</h3>Responsible: Wladislaw Waag<br>Address: Wasserburger Landstr. 29, 81825 Munich, Germany<br>Contact: +49 176 47 11 5206, info@myhome-control.de<br><br>EU dispute settlement: The European Commission provides a platform for online dispute resolution (ODR): <a href='https://ec.europa.eu/consumers/odr/' target='_blank'>https://ec.europa.eu/consumers/odr/</a>.<br><br>Consumer dispute settlement / universal arbitration board: We are neither willing nor obliged to participate in dispute settlement proceedings before a consumer arbitration board.";
		if(document.getElementById('L21')) document.getElementById('L21').innerHTML = "<br><h3>Data privacy</h3>This page is hosted and operated as part of 'Github Pages'. It is possible and probable that Github collects and processes personal data, which then also affects visitors of the wled-compile.github.io web page. We have, however, no influence on it. Please read the Github privacy statement: <a href='https://docs.github.com/en/github/site-policy/github-privacy-statement' target='_blank'>https://docs.github.com/en/github/site-policy/github-privacy-statement</a><br><br>In addition, as soon as you start compiling, your IP address and all the data you entered forwarded to https://myhome-control.de. This is absolutely necessary for the execution of the order. The data protection declaration can be found at <a href=‘ https://shop.myhome-control.de/en/Information/Data-privacy/> https://shop.myhome-control.de/en/Information/Data-privacy/</a><br><br>Our website contains links to external websites over which we have no control. We cannot accept any liability for this third-party content. The respective provider or operator of the pages is always responsible for the content of the linked pages. The linked pages were checked for possible legal violations at the time of linking. Illegal content was not recognizable at that time. If we become aware of any legal violations, we will remove the relevant link immediately.";
		if(document.getElementById('L14a')) document.getElementById('L14a').innerHTML = 'Official WLED Wiki: ';
		if(document.getElementById('L14f')) document.getElementById('L14f').innerHTML = 'WLED FAQ: <a href="https://wled-faq.github.io">https://wled-faq.github.io</a>';
		if(document.getElementById('L14b')) document.getElementById('L14b').innerHTML = 'DIY WLED Boards:';
        if(document.getElementById('L14c')) document.getElementById('L14c').innerHTML = 'Professional WLED Controllers: <a href="https://shop.myhome-control.de">MyHome-Control Shop</a>';
        if(document.getElementById('L14d')) document.getElementById('L14d').innerHTML = 'WEB-based WLED software installer: ';
		if(document.getElementById('L14e')) document.getElementById('L14e').innerHTML = 'WLED power calculator: ';
		if(document.getElementById('L14')) document.getElementById('L14').innerHTML = "Useful links: ";
		if(document.getElementById('L22')) document.getElementById('L22').innerHTML = "start compile/build";

		if(document.getElementById('L25')) document.getElementById('L25').innerHTML = '(old compile helper here: ';
		if(document.getElementById('L26')) document.getElementById('L26').innerHTML = 'Your GitHub account name';
		if(document.getElementById('L27')) document.getElementById('L27').innerHTML = 'Your GitHub repository';
		if(document.getElementById('L30')) document.getElementById('L30').innerHTML = 'Step 1: select WLED software / release / controller type';
		if(document.getElementById('L31')) document.getElementById('L31').innerHTML = 'Step 2: select options';
		if(document.getElementById('L32')) document.getElementById('L32').innerHTML = 'Step 3: select usermods';
		if(document.getElementById('L33')) document.getElementById('L33').innerHTML = 'Step 5: start compiling and download SW when finished';
		if(document.getElementById('L34')) document.getElementById('L34').innerHTML = 'Results to download:';
		if(document.getElementById('L35')) document.getElementById('L35').innerHTML = 'Attention: Please do not enter any personal data (name etc.) or secret information (passwords etc.) when configuring the WLED SW! Compiling takes place on publicly accessible servers so that everyone can see the information you enter!';
		if(document.getElementById('L36')) document.getElementById('L36').innerHTML = 'This is open source software and is provided for free. It is provided "as is", without warranty of any kind, express or implied, including but not limited to the warranties of merchantability, fitness for a particular purpose and noninfringement. In no event shall the owner of this web page be liable for any claim, damages or other liability, whether in an action of contract, tort or otherwise, arising from, out of or in connection with the software or the use or other dealings in the software. The exeption are cases defined by the law. In case German law should be applied, the German version of this disclaimer must be used (please select German language above).';
		if(document.getElementById('L37')) document.getElementById('L37').innerHTML = 'Bitte beachten Sie die Software Lizenzen: <a href="https://wled-install.github.io/WLED_Software_Lizenzen.pdf">WLED licenses</a>';
	}
    if(document.getElementById('lang').selectedIndex==0) {
		document.getElementById('result_line1').innerHTML='Status: <span style="color:green">noch nicht gestartet</span>';
		document.getElementById('result_line2').innerHTML='Download-Link zum Ergebnis: <span style="color:green">noch kein</span>';
	} else {
		document.getElementById('result_line1').innerHTML='State: <span style="color:green">not started yet</span>';
		document.getElementById('result_line2').innerHTML='Download link for the result: <span style="color:green">nothing yet</span>';
	}
}

// $$WLEDPATH$$ Path to zipped source
// echo " " >> platformio.ini
// pio run -e esp32dev || pio run -e esp32dev || true
// $$WLEDPIORUN$$

var generator_state='waiting';
var idreturned='';
var datereturned='';
var wait_cycle_counter=0;
var wait_counter=0;

function GeneratorJob() {

	if(generator_state=='start') {
		SS=document.getElementById('select-sources');
		SSI=SS.selectedIndex;
		SB=document.getElementById('select-branches');
		SBI=SB.selectedIndex;
		var mReq = new XMLHttpRequest();
		console.log(encodeURIComponent(SB.options[SBI].getAttribute("url")));
		mReq.open('POST', 'https://can-gateway.myhome-control.de/api/gate_post2.php?repo='+encodeURIComponent(SB.options[SBI].getAttribute("url").replace("https://","").replace("http://","")));
		mReq.setRequestHeader('Content-type', 'text/plain');
		mReq.onreadystatechange = function () { 
		  if (mReq.readyState === 4 && this.status == 200 && generator_state=='waitforid') {
			var resp=mReq.responseText;
			if(resp.length!=20+1+8) {
			  //alert("Error returned!");
			  idreturned='';
			  datereturned='';
			  generator_state='interrupted';
			  if(document.getElementById('lang').selectedIndex==0) {
					document.getElementById('result_line1').innerHTML='Status: <span style="color:red">Abgebrochen! versuchen Sie erneut!</span>';
					document.getElementById('result_line2').innerHTML='Download-Link zum Ergebnis: <span style="color:red">kein</span>';
				} else {
					document.getElementById('result_line1').innerHTML='State: <span style="color:red">Interrupted!... please try again!</span>';
					document.getElementById('result_line2').innerHTML='Download link for the result: <span style="color:red">nothing</span>';
				}
			  document.getElementById("spinner").style.visibility = "hidden";
			} else {
				//alert("ID returned: "+resp);
				
				datereturned=resp.split(";")[0];
				idreturned=resp.split(";")[1];
				wait_cycle_counter=0;
				generator_state='waitforbuildfinish';
				if(document.getElementById('lang').selectedIndex==0) {
					document.getElementById('result_line1').innerHTML='Status: <span style="color:orange">job wird ausgeführt ... bitte warten und die Seite NICHT neu laden ... es dauert gewöhnlich 5 is 10 Minuten</span>';
					document.getElementById('result_line2').innerHTML='Download-Link zum Ergebnis: <span style="color:orange">noch kein</span>';
				} else {
					document.getElementById('result_line1').innerHTML='State: <span style="color:orange">job is being executed... please wait and DO NOT reload this page ... it takes 5 to 10 minutes usually</span>';
					document.getElementById('result_line2').innerHTML='Download link for the result: <span style="color:orange">nothing yet</span>';
				}
			}
			
		  }
		};
		generator_state='waitforid';
		if(document.getElementById('lang').selectedIndex==0) {
			document.getElementById('result_line1').innerHTML='Status: <span style="color:orange">job wird angefragt ... bitte warten und die Seite NICHT neu laden ... es dauert gewöhnlich 5 is 10 Minuten</span>';
			document.getElementById('result_line2').innerHTML='Download-Link zum Ergebnis: <span style="color:orange">noch kein</span>';
		} else {
			document.getElementById('result_line1').innerHTML='State: <span style="color:orange">job is requested ... please wait and DO NOT reload this page ... it takes 5 to 10 minutes usually</span>';
			document.getElementById('result_line2').innerHTML='Download link for the result: <span style="color:orange">nothing yet</span>';
		}
		mReq.send(document.getElementById('env-text').value.replaceAll("\n","\\n"));
	}
	if(generator_state=='waitforbuildfinish') {
		if(wait_counter>=10) {
			wait_cycle_counter=wait_cycle_counter+1;
			if(wait_cycle_counter>120) {
				generator_state='interrupted';
				if(document.getElementById('lang').selectedIndex==0) {
					document.getElementById('result_line1').innerHTML='Status: <span style="color:red">Abgebrochen wegen Timeout! Versuchen Sie erneut!</span>';
					document.getElementById('result_line2').innerHTML='Download-Link zum Ergebnis: <span style="color:red">kein</span>';
				} else {
					document.getElementById('result_line1').innerHTML='State: <span style="color:red">Interrupted / timeout!... please try again!</span>';
					document.getElementById('result_line2').innerHTML='Download link for the result: <span style="color:red">nothing</span>';
				}
				document.getElementById("spinner").style.visibility = "hidden";
			} else {
				var mReq = new XMLHttpRequest();
				mReq.open('GET', 'https://raw.githubusercontent.com/wled-compile1/myrepo1/refs/heads/main/'+datereturned+'/'+idreturned+'/log.txt');
				mReq.onreadystatechange = function () { 
				  if (mReq.readyState === 4 && this.status == 200 && generator_state=='waitforbuildfinish') {
					generator_state='buildfinished';
					linktofile='https://raw.githubusercontent.com/wled-compile1/myrepo1/refs/heads/main/'+datereturned+'/'+idreturned+'/log.txt';
					if(document.getElementById('lang').selectedIndex==0) {
						document.getElementById('result_line1').innerHTML='Status: <span style="color:green">Abgeschlossen!</span>';
						document.getElementById('result_line2').innerHTML='Bin-Datei: <span style="color:green">... wird generiert ...</span>';
						document.getElementById('result_line3').innerHTML='Download-Link zu Log-Datei: <a href="'+linktofile+'" target="_blank">log.txt</a>';
					} else {
						document.getElementById('result_line1').innerHTML='State: <span style="color:green">Completed!</span>';
						document.getElementById('result_line2').innerHTML='Bin file: <span style="color:green">... being generated ...</span>';
						document.getElementById('result_line3').innerHTML='Download link for the logging file: <a href="'+linktofile+'" target="_blank">log.txt</a>';
					}
					var mReq1 = new XMLHttpRequest();
					mReq1.open('GET', 'https://raw.githubusercontent.com/wled-compile1/myrepo1/refs/heads/main/'+datereturned+'/'+idreturned+'/wled.bin');
					mReq1.onreadystatechange = function () { 
						if (mReq.readyState === 4 && this.status == 200 && generator_state=='buildfinished') {
							generator_state='finished';
							if(document.getElementById('lang').selectedIndex==0) {
								document.getElementById('result_line2').innerHTML='Bin-Datei: <a href="'+'https://raw.githubusercontent.com/wled-compile1/myrepo1/refs/heads/main/'+datereturned+'/'+idreturned+'/wled.bin'+'" download>wled.bin</a>';
							} else {
								document.getElementById('result_line2').innerHTML='Bin file: <a href="'+'https://raw.githubusercontent.com/wled-compile1/myrepo1/refs/heads/main/'+datereturned+'/'+idreturned+'/wled.bin'+'" download>wled.bin</a>';
							}
							document.getElementById("spinner").style.visibility = "hidden";
						}
						if (mReq.readyState === 4 && this.status == 404 && generator_state=='buildfinished') {
							generator_state='interrupted';
							if(document.getElementById('lang').selectedIndex==0) {
								document.getElementById('result_line2').innerHTML='Bin-Datei: <span style="color:red">Fehler! Siehe Log Datei</span>';
							} else {
								document.getElementById('result_line2').innerHTML='Bin file: <span style="color:red">Error! Please check log file</span>';
							}
							document.getElementById("spinner").style.visibility = "hidden";
						}
					};
					mReq1.send();
				  }
				};
				mReq.send();
				
			}
			wait_counter=0;
		} else {
			wait_counter=wait_counter+1;
		}
	}

}

function StartBuildOnline() {
	if(generator_state=='waiting' || generator_state=='interrupted' || generator_state=='finished') {
		// start
		generator_state='start';
		if(document.getElementById('lang').selectedIndex==0) {
			document.getElementById('result_line1').innerHTML='Status: <span style="color:orange">gestartet ... bitte warten und die Seite NICHT neu laden ... es dauert gewöhnlich 5 is 10 Minuten</span>';
			document.getElementById('result_line2').innerHTML='Download-Link zum Ergebnis: <span style="color:orange">noch kein</span>';
		} else {
			document.getElementById('result_line1').innerHTML='State: <span style="color:orange">started ... please wait and DO NOT reload this page ... it takes 5 to 10 minutes usually</span>';
			document.getElementById('result_line2').innerHTML='Download link for the result: <span style="color:orange">nothing yet</span>';
		}
		document.getElementById('result_line3').innerHTML='';
		var interval = setInterval(function() {GeneratorJob();}, 1000);
		document.getElementById("spinner").style.visibility = "visible";
	}
}


window.onload = function () {
	LoadDataset();
	LangChanged();
	document.getElementById("spinner").style.visibility = "hidden";
};
</script>
<script
  type="module"
  src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"
></script>
</body>
</html>
